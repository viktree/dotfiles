#!/bin/sh

USAGE=$(cat <<-END
Usage: port-forward [ENVIRONMENT]

ENVIRONMENT must be one of the following
    hs-dev |hs-stage | hs-prod | hs-prod-ro
    chronos-stage | chronos-prod

END

)

print_usage() {
    echo "$USAGE"
}

if ! command -v 'cloud_sql_proxy' >/dev/null 2>&1; then
    echo 'Error: cloud_sql_proxy cli tool not found'
    echo "please install with 'gcloud components install cloud_sql_proxy'."
    exit 1
fi

ENVIRONMENT=$1
GCP_REGION='us-central1'

case $ENVIRONMENT in

hs-dev)
    GCP_PROJECT_ID='home-services-dev'
    CLOUD_SQL_INSTANCE='home-services-sql-instance-117d8ec3'
    CLOUD_SQL_DB_PORT='5432'
    ;;

hs-stage)
    GCP_PROJECT_ID='home-services-stage'
    CLOUD_SQL_INSTANCE='home-services-sql-instance-790e37c6'
    CLOUD_SQL_DB_PORT='5432'
    ;;

hs-stage-ro)
    GCP_PROJECT_ID='home-services-stage'
    CLOUD_SQL_INSTANCE='home-services-sql-read-replica-db1a5d98'
    CLOUD_SQL_DB_PORT='5432'
    ;;

hs-prod)
    GCP_PROJECT_ID='home-services-prod'
    CLOUD_SQL_INSTANCE='home-services-sql-instance-19b6778a'
    CLOUD_SQL_DB_PORT='5432'
    ;;

hs-prod-ro)
    GCP_PROJECT_ID='home-services-prod'
    CLOUD_SQL_INSTANCE='home-services-sql-read-replica-e2158b06'
    CLOUD_SQL_DB_PORT='5432'
    ;;

chronos-stage)
    GCP_PROJECT_ID='chronos-staging'
    CLOUD_SQL_INSTANCE='chronos-db-stage'
    CLOUD_SQL_DB_PORT='3306'
    ;;
*)
    print_usage
    exit 0
    ;;
esac

cloud_sql_proxy -instances=$GCP_PROJECT_ID:$GCP_REGION:$CLOUD_SQL_INSTANCE=tcp:$CLOUD_SQL_DB_PORT \
    -verbose
# cloud_sql_proxy -instances=$GCP_PROJECT_ID:$GCP_REGION:$CLOUD_SQL_INSTANCE=tcp:127.0.0.1:$CLOUD_SQL_DB_PORT \
#     -ip_address_types="PRIVATE,PUBLIC" \
#     -verbose
